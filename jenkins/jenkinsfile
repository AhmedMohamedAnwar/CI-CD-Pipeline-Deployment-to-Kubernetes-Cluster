pipeline{
  agent any
// Stage checkout from main branch 
  stages {
    stage ('Checkout Main'){
        when{
                branch 'main'
        }        
        steps {
            git branch: 'main',
                credentialsId: 'Github',
                url: 'https://github.com/AhmedMohamedAnwar/CI-CD-Pipeline-Deployment-to-Kubernetes-Cluster'
        }
    }
// Stage checkout from test branch 
    stage ('Checkout test'){
        when{
                branch 'test'
        }           
        steps {
            git branch: 'test',
                credentialsId: 'Github',
                url: 'https://github.com/AhmedMohamedAnwar/CI-CD-Pipeline-Deployment-to-Kubernetes-Cluster'
        }
    }

// Stage Scanning docker image   

stage('Trivy Scanner') {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: trivy
    image: aquasec/trivy:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: jenkins-home
      mountPath: /workspace
  volumes:
  - name: jenkins-home
    persistentVolumeClaim:
      claimName: claim-jenkins-pv
            """
        }
    }
    steps {
        container('trivy') {
<<<<<<< HEAD
            // sh 'trivy fs ${WORKSPACE} --exit-code 1 || true'
        sh '''
          # Scan filesystem (node_modules, packages...)
          trivy fs ${WORKSPACE} --exit-code 1 || true

          # Scan Dockerfiles + Kubernetes YAMLs
          trivy config ${WORKSPACE} --exit-code 1 || true
        '''
        }
    }
}
=======
            sh 'trivy fs ${WORKSPACE} --exit-code 1 || true'
        }
    }
}





>>>>>>> b0de7bf50c7397f947902553b05e2fd3c4111631
  }
}