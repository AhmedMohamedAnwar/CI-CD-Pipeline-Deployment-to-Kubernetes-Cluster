pipeline{
  agent any
// Stage checkout from main branch 
  stages {
    stage ('Checkout Main'){
        when{
                branch 'main'
        }        
        steps {
            git branch: 'main',
                credentialsId: 'Github',
                url: 'https://github.com/AhmedMohamedAnwar/CI-CD-Pipeline-Deployment-to-Kubernetes-Cluster'
        }
    }
// Stage checkout from test branch 
    stage ('Checkout test'){
        when{
                branch 'test'
        }           
        steps {
            git branch: 'test',
                credentialsId: 'Github',
                url: 'https://github.com/AhmedMohamedAnwar/CI-CD-Pipeline-Deployment-to-Kubernetes-Cluster'
        }
    }
// Stage Scanning docker image   
    // stage ('Trivy scanner'){
    //     agent{
    //         docker {
    //             image 'aquasec/trivy:latest'
    //             args '-v $WORKSPACE:/workspace'
    //         }            
    //     }
    //     steps{  
    //         sh 'trivy fs /workspace --exit-code 1 || true'
    //     }
    // }


//   --------------------------------------------- 

    // stage('Trivy Scanner') {
    //     agent {
    //         kubernetes {
    //             yaml """
    // apiVersion: v1
    // kind: Pod
    // spec:
    // containers:
    // - name: trivy
    //     image: aquasec/trivy:latest
    //     command:
    //     - cat
    //     tty: true
    // """
    //         }
    //     }
    //     steps {
    //         container('trivy') {
    //             sh 'trivy fs /workspace --exit-code 1 || true'
    //         }
    //     }
    // }  



stage('Trivy Scanner') {
    agent {
        kubernetes {
            yaml """
            apiVersion: v1
            kind: Pod
            spec:
            containers:
            - name: trivy
                image: aquasec/trivy:latest
                command:
                - cat
                tty: true
                volumeMounts:
                - name: jenkins-home
                mountPath: /workspace
            volumes:
            - name: jenkins-home
                persistentVolumeClaim:
                claimName: claim-jenkins-pv
            """
        }
    }
    steps {
        container('trivy') {
            sh 'trivy fs /workspace/workspace/$JOB_NAME --exit-code 1 || true'
        }
    }
}





  }
}