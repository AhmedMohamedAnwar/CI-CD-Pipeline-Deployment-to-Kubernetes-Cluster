pipeline{
  agent any
// Stage checkout from main branch 
  stages {
    stage ('Checkout Main'){
        when{
                branch 'main'
        }        
        steps {
            git branch: 'main',
                credentialsId: 'Github',
                url: 'https://github.com/AhmedMohamedAnwar/CI-CD-Pipeline-Deployment-to-Kubernetes-Cluster'
        }
    }
// Stage checkout from test branch 
    stage ('Checkout test'){
        when{
                branch 'test'
        }           
        steps {
            git branch: 'test',
                credentialsId: 'Github',
                url: 'https://github.com/AhmedMohamedAnwar/CI-CD-Pipeline-Deployment-to-Kubernetes-Cluster'
        }
    }
// Stage Scanning docker image   
    stage ('Trivy scanner'){
        agent{
            docker {
                image 'aquasec/trivy:latest'
                args '-v $WORKSPACE:/workspace'
            }            
        }
        steps{  
            sh 'trivy fs /workspace --exit-code 1 || true'
        }
    }
  }
}