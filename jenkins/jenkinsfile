pipeline {
    agent any

    stages {
        // Stage checkout from main branch 
        stage('Checkout Main') {
            when {
                branch 'main'
            }        
            steps {
                git branch: 'main',
                    credentialsId: 'Github',
                    url: 'https://github.com/AhmedMohamedAnwar/CI-CD-Pipeline-Deployment-to-Kubernetes-Cluster'
            }
        }

        // Stage checkout from test branch 
        stage('Checkout test') {
            when {
                branch 'test'
            }           
            steps {
                git branch: 'test',
                    credentialsId: 'Github',
                    url: 'https://github.com/AhmedMohamedAnwar/CI-CD-Pipeline-Deployment-to-Kubernetes-Cluster'
            }
        }

        // Stage Scanning docker image   
        stage('Trivy Scanner') {
            agent {
                kubernetes {
                    yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: trivy
    image: aquasec/trivy:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: jenkins-home
      mountPath: /workspace
  volumes:
  - name: jenkins-home
    persistentVolumeClaim:
      claimName: claim-jenkins-pv
                    """
                }
            }
            steps {
                container('trivy') {
                    sh '''
                      # Scan filesystem (node_modules, packages...)
                      trivy fs ${WORKSPACE} --exit-code 1 || true

                      # Scan Dockerfiles + Kubernetes YAMLs
                      trivy config ${WORKSPACE} --exit-code 1 || true
                    '''
                }
            }
        }

        // Testing APP   
        stage('Test app') {
            steps {
                echo "Test app"
            }
        }

        // Build Docker Image and push to Docker hub
stage('Build Image & Push') {
  agent {
    kubernetes {
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:

  # Docker Daemon (DIND)
  - name: dind
    image: docker:24.0.5-dind
    securityContext:
      privileged: true
    env:
    - name: DOCKER_TLS_CERTDIR
      value: ""        # Disable TLS
    command:
    - dockerd
    args:
    - --host=tcp://0.0.0.0:2375
    - --host=unix:///var/run/docker.sock

  # Docker client
  - name: docker
    image: docker:24.0.5
    command: ["sleep"]
    args: ["9999"]
"""
    }
  }

  steps {
    container('docker') {

      withCredentials([usernamePassword(
        credentialsId: 'Dockerhub',
        usernameVariable: 'DOCKER_USER',
        passwordVariable: 'DOCKER_PASS'
      )]) {

        sh """
          # Wait until Docker daemon becomes ready
          for i in {1..20}; do
            docker -H tcp://dind:2375 info && break
            echo "Waiting for Docker daemon..."
            sleep 2
          done

          # Login & Build
          echo \$DOCKER_PASS | docker -H tcp://dind:2375 login -u \$DOCKER_USER --password-stdin
          docker -H tcp://dind:2375 build -t ahmedmanwar/cicd-app:latest ${WORKSPACE}
          docker -H tcp://dind:2375 push ahmedmanwar/cicd-app:latest
        """
      }
    }
  }
}

    }                 // end of stages
}                    // end of pipeline
