pipeline {
    agent any

    stages {
        // Stage checkout from main branch 
        stage('Checkout Main') {
            when {
                branch 'main'
            }        
            steps {
                git branch: 'main',
                    credentialsId: 'Github',
                    url: 'https://github.com/AhmedMohamedAnwar/CI-CD-Pipeline-Deployment-to-Kubernetes-Cluster'
            }
        }

        // Stage checkout from test branch 
        stage('Checkout test') {
            when {
                branch 'test'
            }           
            steps {
                git branch: 'test',
                    credentialsId: 'Github',
                    url: 'https://github.com/AhmedMohamedAnwar/CI-CD-Pipeline-Deployment-to-Kubernetes-Cluster'
            }
        }

        // Stage Scanning docker image   
        stage('Trivy Scanner') {
            agent {
                kubernetes {
                    yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: trivy
    image: aquasec/trivy:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: jenkins-home
      mountPath: /workspace
  volumes:
  - name: jenkins-home
    persistentVolumeClaim:
      claimName: claim-jenkins-pv
                    """
                }
            }
            steps {
                container('trivy') {
                    sh '''
                      # Scan filesystem (node_modules, packages...)
                      trivy fs ${WORKSPACE} --exit-code 1 || true

                      # Scan Dockerfiles + Kubernetes YAMLs
                      trivy config ${WORKSPACE} --exit-code 1 || true
                    '''
                }
            }
        }

        // Testing APP   
        stage('Test app') {
            steps {
                echo "Test app"
            }
        }

        stage('Build & Push Images (Kaniko)') {
                    agent {
                        kubernetes {
                            yaml """
        apiVersion: v1
        kind: Pod
        spec:
          containers:
            - name: kaniko
              image: gcr.io/kaniko-project/executor:debug
              command:
                - sleep
              args:
                - "99999"
              volumeMounts:
                - name: docker-config
                  mountPath: /kaniko/.docker/
          volumes:
            - name: docker-config
              emptyDir: {}
        """
                        }
                    }
        
                    steps {
                        container('kaniko') {
                            withCredentials([usernamePassword(
                                credentialsId: 'Dockerhub',
                                usernameVariable: 'DOCKER_USER',
                                passwordVariable: 'DOCKER_PASS'
                            )]) {
                                sh '''
                                    set -e
                                    
                                    echo "Creating Docker config..."
                                    mkdir -p /kaniko/.docker
                                    
                                    # Create config.json with proper authentication
                                    echo -n "${DOCKER_USER}:${DOCKER_PASS}" | base64 -w 0 > /tmp/auth.txt
                                    
                                    echo '{' > /kaniko/.docker/config.json
                                    echo '  "auths": {' >> /kaniko/.docker/config.json
                                    echo '    "https://index.docker.io/v1/": {' >> /kaniko/.docker/config.json
                                    echo -n '      "auth": "' >> /kaniko/.docker/config.json
                                    cat /tmp/auth.txt >> /kaniko/.docker/config.json
                                    echo '"' >> /kaniko/.docker/config.json
                                    echo '    }' >> /kaniko/.docker/config.json
                                    echo '  }' >> /kaniko/.docker/config.json
                                    echo '}' >> /kaniko/.docker/config.json
                                    
                                    rm /tmp/auth.txt
                                    
                                    echo "Docker config created successfully"
                                    
                                    echo "Building Arabic image..."
                                    /kaniko/executor \
                                        --context ${WORKSPACE}/app/arabic \
                                        --dockerfile ${WORKSPACE}/app/arabic/Dockerfile \
                                        --destination=ahmedmanwar/cicd-app-ar:latest \
                                        --verbosity=info
                                    
                                    echo "Building English image..."
                                    /kaniko/executor \
                                        --context ${WORKSPACE}/app/english \
                                        --dockerfile ${WORKSPACE}/app/english/Dockerfile \
                                        --destination=ahmedmanwar/cicd-app-en:latest \
                                        --verbosity=info
                                    
                                    echo "All images built and pushed successfully!"
                                '''
                            }
                        }
                    }
                }
    } // end of stages
} // end of pipeline
